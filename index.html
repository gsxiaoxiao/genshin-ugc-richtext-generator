<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>原神 · 千星奇域文本转换器</title>

  <style>
    :root{
      --bg0:#050814;
      --bg1:#08102a;
      --line: rgba(140, 190, 255, .14);
      --line2: rgba(140, 190, 255, .22);
      --text: rgba(235,245,255,.92);
      --muted: rgba(235,245,255,.62);
      --glow: 0 0 24px rgba(98,176,255,.18), 0 0 60px rgba(138,92,255,.12);
      --shadow: 0 16px 60px rgba(0,0,0,.55);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
    }

    @font-face{
      font-family: "GenshinZH";
      src: url("./zh-cn.ttf") format("truetype");
      font-display: swap;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      color: var(--text);
      font-family: var(--sans);
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(98,176,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(138,92,255,.16), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(98,176,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
    }

    .wrap{
      max-width: 1400px;
      margin: 14px auto;
      padding: 12px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 12px;
    }

    .topbar{
      padding: 14px 16px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      box-shadow: var(--shadow), var(--glow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{display:flex; flex-direction:column; gap:4px; min-width:0;}
    .brand h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.4px;
      text-shadow: 0 0 18px rgba(98,176,255,.25);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand .sub{font-size: 12.5px; color: var(--muted);}
    .brand .sub strong{color: rgba(235,245,255,.86); font-family: var(--mono); font-weight: 900;}

    .quick{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .pill{
      display:flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      box-shadow: 0 0 14px rgba(98,176,255,.08);
      font-size: 12px;
      color: rgba(235,245,255,.86);
      white-space:nowrap;
    }
    .pill code{font-family: var(--mono); font-weight: 900; color: rgba(235,245,255,.92);}

    .btn{
      cursor:pointer;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(98,176,255,.10);
      color: rgba(235,245,255,.92);
      padding: 10px 12px;
      font-weight: 900;
      letter-spacing:.2px;
      box-shadow: 0 0 18px rgba(98,176,255,.10);
      transition: .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(98,176,255,.14); }
    .btn:active{ transform: translateY(0); }
    .btn2{ background: rgba(138,92,255,.10); box-shadow: 0 0 18px rgba(138,92,255,.10); }

    /* ✅ 左边更宽：62 / 38 */
    .main{
      display:grid;
      grid-template-columns: 1.65fr 1fr;
      gap: 12px;
      min-height: 0;
    }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      box-shadow: var(--shadow), var(--glow);
      overflow: hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .cardHead{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(140,190,255,.12);
      background: rgba(0,0,0,.14);
    }
    .cardHead .t{
      font-weight: 950;
      letter-spacing:.25px;
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .tag{
      font-size: 12px;
      color: var(--muted);
      border: 1px solid rgba(140,190,255,.14);
      background: rgba(0,0,0,.12);
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }

    /* 左侧：输入更大更舒服 */
    .leftBody{
      display:grid;
      grid-template-rows: 1.25fr .75fr;
      gap: 12px;
      padding: 12px;
      min-height: 0;
    }
    .panelBox{
      border-radius: 14px;
      border: 1px solid rgba(140,190,255,.14);
      background: rgba(0,0,0,.20);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      min-height: 0;
      overflow: hidden;
      display:flex;
      flex-direction:column;
    }
    .editor{
      padding: 14px;
      outline:none;
      line-height: 1.65;
      font-size: 16px;
      color: #ffffff;
      font-family: "GenshinZH", var(--sans);
      white-space: pre-wrap;
      word-break: break-word;
      overflow:auto;
      flex:1;
      min-height: 420px;
    }
    .editor:empty:before{
      content: attr(data-placeholder);
      color: rgba(235,245,255,.28);
    }
    .output{
      border: none;
      background: transparent;
      color: rgba(235,245,255,.92);
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.6;
      outline:none;
      resize: none;
      padding: 12px;
      overflow:auto;
      flex:1;
      min-height: 180px;
    }

    /* 右侧：尽量一屏塞下 */
    .rightBody{
      padding: 12px;
      display:grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      min-height: 0;
    }

    .controls{
      border-radius: 14px;
      border: 1px solid rgba(140,190,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
      align-items:end;
    }
    .ctrl{display:flex; flex-direction:column; gap:8px; min-width:0;}
    .ctrl label{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .ctrl label code{font-family: var(--mono); font-weight: 900; color: rgba(235,245,255,.92);}

    input[type="range"]{ width:100%; }
    select{
      height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(140,190,255,.16);
      background: rgba(0,0,0,.22);
      color: rgba(235,245,255,.92);
      padding: 0 12px;
      outline:none;
      box-shadow: 0 0 16px rgba(98,176,255,.08);
    }

    /* ✅ 保留你截图那种系统取色器 */
    .colorRow{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    input[type="color"]{
      width: 44px;
      height: 38px;
      padding: 0;
      border: none;
      background: transparent;
      filter: drop-shadow(0 0 10px rgba(98,176,255,.18));
    }
    .colorPreview{
      flex: 1;
      height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(140,190,255,.16);
      background: rgba(255,255,255,.06);
      box-shadow: 0 0 16px rgba(98,176,255,.10);
    }

    .toggle{
      cursor:pointer;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(140,190,255,.16);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      transition:.15s ease;
      height: 38px;
    }
    .toggle:hover{ background: rgba(0,0,0,.24); }
    .toggle input{ transform: translateY(1px); }

    /* ✅ 官方色：小胶囊按钮，一屏尽量放完 */
    .presets{
      border-radius: 14px;
      border: 1px solid rgba(140,190,255,.14);
      background: rgba(0,0,0,.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      padding: 10px;
      overflow:hidden;
      min-height: 0;
    }
    .groupTitle{
      font-weight: 950;
      font-size: 12px;
      color: rgba(235,245,255,.82);
      margin: 8px 2px 6px;
      letter-spacing:.2px;
    }
    .chipGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr)); /* ✅ 更密：5列 */
      gap: 6px;
    }
    .chip{
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(140,190,255,.14);
      background: rgba(255,255,255,.04);
      user-select:none;
      transition:.12s ease;
      min-width:0;
      height: 34px;
    }
    .chip:hover{ background: rgba(255,255,255,.07); }
    .chip.active{
      border-color: rgba(235,245,255,.78);
      box-shadow: 0 0 18px rgba(98,176,255,.12);
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,.35);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
      flex: 0 0 auto;
    }
    .chip span{
      font-size: 12px;
      font-weight: 900;
      color: rgba(235,245,255,.86);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .note{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(235,245,255,.56);
      line-height: 1.45;
    }

    @media (max-width: 1180px){
      .main{ grid-template-columns: 1fr; }
      .controls{ grid-template-columns: 1fr; }
      .chipGrid{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .presets{ overflow:auto; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>原神 · 千星奇域文本转换器</h1>
        <div class="sub">作者：<strong>@孤山笑笑</strong> · 抱歉我的服务器太卡啦，不支持预览原神本体的字体，支持原神千星奇域规则：<strong>\n</strong> <strong>&lt;color&gt;</strong> <strong>&lt;size&gt;</strong> <strong>&lt;b&gt;</strong> <strong>&lt;i&gt;</strong></div>
      </div>
      <div class="quick">
        <div class="pill">颜色：<code id="showColor">#FFFFFF</code></div>
        <div class="pill">大小：<code id="showSize">16</code></div>
        <div class="pill">样式：<code id="showBI">-</code></div>
        <a href="index.html" class="btn" title="返回首页">返回首页</a>
        <button class="btn btn2" id="btnCopy">复制输出</button>
        <button class="btn" id="btnClear">清空</button>
      </div>
    </div>

    <div class="main">
      <!-- 左侧 -->
      <div class="card">
        <div class="cardHead">
          <div class="t">输入 & 预览 <span class="tag">为避免bug，圈选文本后点击右侧控件修改格式</span></div>
        </div>
        <div class="leftBody">
          <div class="panelBox">
            <div id="editor" class="editor" contenteditable="true" data-placeholder="在这里输入…"></div>
          </div>
          <div class="panelBox">
            <textarea id="output" class="output" readonly placeholder="这里生成可复制到原神的标签文本…"></textarea>
          </div>
        </div>
      </div>

      <!-- 右侧 -->
      <div class="card">
        <div class="cardHead">
          <div class="t">功能区 <span class="tag">请先圈选文本，再点击设置</span></div>
        </div>

        <div class="rightBody">
          <div class="controls">
            <div class="ctrl">
              <label>颜色 <code id="colorHex">#FFFFFF</code></label>
              <div class="colorRow">
                <input type="color" id="rgbPicker" value="#ffffff" />
                <div class="colorPreview" id="colorPreview"></div>
              </div>
            </div>

            <div class="ctrl">
              <label>透明度AA（00~FF）<code id="aaHex">FF</code></label>
              <input type="range" id="alphaRange" min="0" max="255" value="255">
            </div>

            <div class="ctrl">
              <label>大小（1~200）</label>
              <select id="sizeSelect"></select>
            </div>

            <label class="toggle" title="粗体">
              <input type="checkbox" id="boldChk">
              <span style="font-weight:950;">粗体（&lt;b&gt;）</span>
            </label>

            <label class="toggle" title="斜体">
              <input type="checkbox" id="italicChk">
              <span style="font-weight:950;">斜体（&lt;i&gt;）</span>
            </label>


          </div>

          <div class="presets" id="presetContainer">
            <div class="note">提示：请先圈选文本，再点击色块应用颜色。</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ✅ 官方色
  const PRESET_GROUPS = [
    ["深色底（弹窗/主界面中）", [
      ["标题/次要", "#D3BC8E"],
      ["普通", "#FFFFFF"],
      ["关键1", "#FFCC33"],
      ["关键2", "#37FFFF"],
      ["警示", "#FF5E41"],
    ]],
    ["浅色底（Tips等）", [
      ["普通", "#4A5366"],
      ["次要75%", "#4A5366BF"],
      ["关键1", "#F39000"],
      ["关键2", "#3399CC"],
      ["警示", "#FF5E41"],
    ]],
    ["元素属性", [
      ["水", "#80C0FF"],
      ["火", "#FF9999"],
      ["风", "#80FFD7"],
      ["雷", "#FFACFF"],
      ["草", "#99FF88"],
      ["冰", "#99FFFF"],
      ["岩", "#FFE699"],
    ]],
    ["品质", [
      ["灰", "#CCCCCC"],
      ["绿", "#ACFF44"],
      ["蓝", "#50F4FF"],
      ["紫", "#F998FF"],
      ["橙", "#FFE14B"],
    ]],
  ];

  const editor = document.getElementById('editor');
  const output = document.getElementById('output');

  const rgbPicker = document.getElementById('rgbPicker');
  const alphaRange = document.getElementById('alphaRange');
  const sizeSelect = document.getElementById('sizeSelect');
  const boldChk = document.getElementById('boldChk');
  const italicChk = document.getElementById('italicChk');

  const colorHexEl = document.getElementById('colorHex');
  const aaHexEl = document.getElementById('aaHex');
  const colorPreview = document.getElementById('colorPreview');

  const showColor = document.getElementById('showColor');
  const showSize  = document.getElementById('showSize');
  const showBI    = document.getElementById('showBI');

  const btnCopy = document.getElementById('btnCopy');
  const btnClear = document.getElementById('btnClear');
  const btnClearFmt = document.getElementById('btnClearFmt');
  const presetContainer = document.getElementById('presetContainer');

  const clamp = (n,min,max)=>Math.min(max, Math.max(min,n));
  const toHex2 = (n)=>n.toString(16).toUpperCase().padStart(2,'0');

  // 当前样式
  let currentStyle = {
    colorHex: "#FFFFFF",
    size: 16,
    bold: false,
    italic: false,
  };

  // 刷新顶部状态栏
  function refreshTopStatus(){
    showColor.textContent = currentStyle.colorHex;
    showSize.textContent = String(currentStyle.size);
    const bi = [];
    if(currentStyle.bold) bi.push("B");
    if(currentStyle.italic) bi.push("I");
    showBI.textContent = bi.length ? bi.join("") : "-";
  }

  // 构建颜色十六进制字符串
  function buildColorHex(rgbHex, alpha){
    const r = rgbHex.slice(1,3), g = rgbHex.slice(3,5), b = rgbHex.slice(5,7);
    const a = toHex2(alpha);
    return (alpha === 255) ? `#${r}${g}${b}` : `#${r}${g}${b}${a}`;
  }

  // 十六进制转RGBA
  function hexToCssRgba(hex){
    const hex2rgba = (hex)=>{
      hex = hex.replace('#','').trim();
      if(hex.length===6){
        return {r:parseInt(hex.slice(0,2),16), g:parseInt(hex.slice(2,4),16), b:parseInt(hex.slice(4,6),16), a:255};
      }
      if(hex.length===8){
        return {r:parseInt(hex.slice(0,2),16), g:parseInt(hex.slice(2,4),16), b:parseInt(hex.slice(4,6),16), a:parseInt(hex.slice(6,8),16)};
      }
      return {r:255,g:255,b:255,a:255};
    };
    const {r,g,b,a} = hex2rgba(hex);
    return `rgba(${r},${g},${b},${a/255})`;
  }

  // 获取编辑器中的选区
  function getRangeInEditor(){
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return null;
    const r = sel.getRangeAt(0);
    if(!editor.contains(r.commonAncestorContainer)) return null;
    return r;
  }

  // 应用样式到span
  function applyStyleToSpan(span, style){
    span.dataset.fmt = "1";
    span.style.color = hexToCssRgba(style.colorHex);
    span.style.fontSize = `${style.size}px`;
    span.style.fontWeight = style.bold ? "800" : "400";
    span.style.fontStyle = style.italic ? "italic" : "normal";
    span.dataset.color = style.colorHex.toUpperCase();
    span.dataset.size = String(style.size);
    span.dataset.bold = style.bold ? "1" : "0";
    span.dataset.italic = style.italic ? "1" : "0";
  }

function stripFmtInFragment(root){
  // 把选区里旧的格式span(data-fmt="1")展开掉
  const nodes = [];
  const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT);
  while(walker.nextNode()){
    const el = walker.currentNode;
    if(el && el.dataset && el.dataset.fmt === "1") nodes.push(el);
  }
  // 从里到外处理，避免嵌套乱掉
  nodes.reverse().forEach(el=>{
    const parent = el.parentNode;
    while(el.firstChild) parent.insertBefore(el.firstChild, el);
    parent.removeChild(el);
  });
}

  // 将选区包裹在span中
  function wrapRangeWithSpan(range, style){
    if(!range || range.collapsed) return false;
    const frag = range.extractContents();
    stripFmtInFragment(frag);
    const span = document.createElement('span');
    applyStyleToSpan(span, style);
    span.appendChild(frag);
    range.insertNode(span);

    // 光标移到末尾
    const sel = window.getSelection();
    sel.removeAllRanges();
    const nr = document.createRange();
    nr.selectNodeContents(span);
    sel.addRange(nr);
    return true;
  }

  // 同步当前样式到面板
  function syncCurrentFromPanel(){
    const a = clamp(parseInt(alphaRange.value,10),0,255);
    const hex = buildColorHex(rgbPicker.value.toUpperCase(), a);
    currentStyle.colorHex = hex;
    currentStyle.size = parseInt(sizeSelect.value,10);
    currentStyle.bold = !!boldChk.checked;
    currentStyle.italic = !!italicChk.checked;

    colorHexEl.textContent = hex;
    aaHexEl.textContent = toHex2(a);
    colorPreview.style.background = hexToCssRgba(hex);

    refreshTopStatus();
  }

  // 应用样式到选区
  function applyToSelection(){
    syncCurrentFromPanel();
    
    // 获取当前选区
    const range = getRangeInEditor();
    if(range && !range.collapsed){
      wrapRangeWithSpan(range, currentStyle);
      refreshOutput();
    }
  }

  // 绑定应用事件
  function bindApply(el, evt){
    el.addEventListener(evt, applyToSelection);
  }

  // 初始化大小选项
  // 8-20：逐个数字
  for(let i=8;i<=20;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    if(i===16) opt.selected = true;
    sizeSelect.appendChild(opt);
  }
  // 22-36：每2个数字一个选项
  for(let i=22;i<=36;i+=2){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    sizeSelect.appendChild(opt);
  }
  // 40-72：每4个数字一个选项
  for(let i=40;i<=72;i+=4){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    sizeSelect.appendChild(opt);
  }
  // 80-200：每10个数字一个选项
  for(let i=80;i<=200;i+=10){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    sizeSelect.appendChild(opt);
  }

  // 绑定控件事件
  bindApply(rgbPicker, "change");
  bindApply(alphaRange, "input");
  bindApply(sizeSelect, "change");
  bindApply(boldChk, "change");
  bindApply(italicChk, "change");

  // 预设颜色
  function clearPresetActive(){
    presetContainer.querySelectorAll(".chip.active").forEach(el=>el.classList.remove("active"));
  }
  function setColorFromPreset(hex){
    const rgba = (hex)=>{
      hex = hex.replace('#','').trim();
      if(hex.length===6){
        return {r:parseInt(hex.slice(0,2),16), g:parseInt(hex.slice(2,4),16), b:parseInt(hex.slice(4,6),16), a:255};
      }
      if(hex.length===8){
        return {r:parseInt(hex.slice(0,2),16), g:parseInt(hex.slice(2,4),16), b:parseInt(hex.slice(4,6),16), a:parseInt(hex.slice(6,8),16)};
      }
      return {r:255,g:255,b:255,a:255};
    };
    
    const color = rgba(hex);
    rgbPicker.value = `#${toHex2(color.r)}${toHex2(color.g)}${toHex2(color.b)}`;
    alphaRange.value = color.a;
    syncCurrentFromPanel();
    
    // 应用到选区
    const range = getRangeInEditor();
    if(range && !range.collapsed){
      wrapRangeWithSpan(range, currentStyle);
      refreshOutput();
    }
  }

  // 渲染预设颜色
  (function renderPresets(){
    presetContainer.innerHTML = "";
    PRESET_GROUPS.forEach(([groupName, items])=>{
      const title = document.createElement("div");
      title.className = "groupTitle";
      title.textContent = groupName;

      const grid = document.createElement("div");
      grid.className = "chipGrid";

      items.forEach(([name, hex])=>{
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.dataset.hex = hex.toUpperCase();
        chip.title = `${name}  ${hex.toUpperCase()}`;

        const dot = document.createElement("div");
        dot.className = "dot";
        dot.style.background = hexToCssRgba(hex);

        const span = document.createElement("span");
        span.textContent = name;

        chip.appendChild(dot);
        chip.appendChild(span);

        chip.addEventListener("click", ()=>{
          clearPresetActive();
          chip.classList.add("active");
          setColorFromPreset(hex.toUpperCase());
        });

        grid.appendChild(chip);
      });

      presetContainer.appendChild(title);
      presetContainer.appendChild(grid);
    });

    const note = document.createElement("div");
    note.className = "note";
    note.textContent = "提示：请先圈选文本，再点击色块应用颜色。";
    presetContainer.appendChild(note);
  })();

  // 生成输出
  function refreshOutput(){
    // 从编辑器提取内容并生成标签
    const segs = [];
    function walk(node, parentEl){
      if(node.nodeType === Node.TEXT_NODE){
        let t = node.nodeValue || "";
        if(!t) return;
        const style = getEffectiveStyleForNode(parentEl);
        segs.push({type:"text", text:t, style});
        return;
      }
      if(node.nodeType !== Node.ELEMENT_NODE) return;
      const el = node;
      if(el.tagName === "BR"){ segs.push({type:"nl"}); return; }

      const isBlock = (el.tagName === "DIV" || el.tagName === "P");
      if(isBlock){
        const before = segs.length;
        el.childNodes.forEach(ch=>walk(ch, el));
        if(segs.length>0 && (before!==segs.length || el.childNodes.length===0)){
          segs.push({type:"nl"});
        }
        return;
      }
      el.childNodes.forEach(ch=>walk(ch, el));
    }
    
function getEffectiveStyleForNode(el){
  // ✅ 优先用我们自己存的 data- 属性，避免 computedStyle 反推导致色值漂移
  let p = el;
  while(p && p !== editor){
    if(p.dataset && p.dataset.fmt === "1"){
      return {
        color: (p.dataset.color || null),
        size: p.dataset.size ? parseInt(p.dataset.size, 10) : null,
        bold: p.dataset.bold === "1",
        italic: p.dataset.italic === "1",
      };
    }
    p = p.parentElement;
  }

  // 兜底：如果不是我们打过格式的 span，再用 computedStyle
  const cs = window.getComputedStyle(el);
  const rgbStrToHex = (colorStr)=>{
    const m = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/i);
    if(!m) return null;
    const r = parseInt(m[1],10), g=parseInt(m[2],10), b=parseInt(m[3],10);
    let a = 1;
    if(m[4] !== undefined) a = parseFloat(m[4]);
    const aa = Math.round(a*255);
    const base = `#${toHex2(r)}${toHex2(g)}${toHex2(b)}`;
    return (aa===255) ? base : `${base}${toHex2(aa)}`;
  };

  const color = rgbStrToHex(cs.color);
  const sizePx = parseFloat(cs.fontSize);
  const italic = (cs.fontStyle || "").toLowerCase() === "italic";
  const bold = (parseInt(cs.fontWeight,10) || 400) >= 700;
  return {
    color: color,
    size: Number.isFinite(sizePx) ? Math.round(sizePx) : null,
    bold,
    italic
  };
}

    
    editor.childNodes.forEach(ch=>walk(ch, editor));
    while(segs.length && segs[segs.length-1].type==="nl") segs.pop();
    
    // 生成标签
    function styleKey(s){ return `${s.size||""}|${(s.color||"").toUpperCase()}|${s.bold?"1":"0"}|${s.italic?"1":"0"}`; }
    function openTags(s){ 
      const tags = [];
      if(s.size) tags.push(`<size=${s.size}>`);
      if(s.color) tags.push(`<color=${s.color.toUpperCase()}>`);
      if(s.bold) tags.push(`<b>`);
      if(s.italic) tags.push(`<i>`);
      return tags;
    }
    function closeTags(s){ 
      const tags = [];
      if(s.italic) tags.push(`</i>`);
      if(s.bold) tags.push(`</b>`);
      if(s.color) tags.push(`</color>`);
      if(s.size) tags.push(`</size>`);
      return tags;
    }
    
    let out = "";
    let prev = null;
    for(const seg of segs){
      if(seg.type==="nl"){ out += "\\n"; continue; }
      const style = seg.style;
      if(!prev || styleKey(prev) !== styleKey(style)){
        if(prev) out += closeTags(prev).join("");
        out += openTags(style).join("");
        prev = style;
      }
      out += seg.text;
    }
    if(prev) out += closeTags(prev).join("");
    
    output.value = out;
  }

  // 输入事件监听
  editor.addEventListener("input", ()=>{
    refreshOutput();
  });

  // 复制输出
  btnCopy.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(output.value);
      btnCopy.textContent = "已复制 ✓";
      setTimeout(()=>btnCopy.textContent="复制输出", 900);
    }catch(e){
      output.focus(); output.select();
      document.execCommand("copy");
      btnCopy.textContent = "已复制 ✓";
      setTimeout(()=>btnCopy.textContent="复制输出", 900);
    }
  });

  // 清空
  btnClear.addEventListener("click", ()=>{
    if(confirm("确定清空输入内容？")){
      editor.innerHTML = "";
      refreshOutput();
    }
  });

  // 初始化
  syncCurrentFromPanel();
  refreshTopStatus();
  refreshOutput();
</script>
</body>
</html>
